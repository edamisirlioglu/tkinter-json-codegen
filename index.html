<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Tkinter JSON Code Generator - V0.1</title>
  
  <!-- Tailwind CSS CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Lucide Icons (Aesthetics) -->
  <script src="https://unpkg.com/lucide@latest"></script>
  <!-- Prism for Syntax Highlighting -->
  <link href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-tomorrow.min.css" rel="stylesheet" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-python.min.js"></script>
  <!-- AJV for JSON Schema Validation -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/ajv/6.12.6/ajv.min.js"></script>

  <style>
    /* Inter Font and Code Box Styles */
    body { font-family: 'Inter', sans-serif; }
    /* Code box background styles for both themes */
    #code-output-container {
      background-color: #1e293b; /* slate-800 */
      border-radius: 0.75rem; /* rounded-xl */
      padding: 1rem;
      overflow: auto;
      min-height: 400px;
    }
    .dark #code-output-container {
      background-color: #0f172a; /* slate-900 */
    }
    
    /* Global transition for smoothness */
    .transition-all { transition: all 0.3s ease; }
    
    /* Prism JS fix: Override Tailwind pre/code styles */
    pre[class*="language-"] {
        padding: 0 !important;
        margin: 0 !important;
        background: transparent !important;
        white-space: pre-wrap !important; 
        word-break: break-all !important;
    }
  </style>
</head>

<body class="min-h-screen flex flex-col bg-slate-100 text-slate-800 transition-all duration-300">

  <!-- NAVBAR -->
  <nav id="navbar" class="flex items-center justify-between px-6 py-4 bg-white/80 backdrop-blur-md shadow-lg transition-all duration-300 rounded-b-xl">
    <h1 class="text-2xl font-extrabold flex items-center gap-2">
      <i data-lucide="zap" class="w-7 h-7 text-indigo-600"></i> 
      <!-- Title text color dynamically adjusted for Dark Mode -->
      <span id="navTitle" class="text-slate-900 dark:text-white transition-colors duration-300">Tkinter CodeGen</span>
    </h1>

    <!-- Theme Toggle -->
    <button id="themeToggle" class="p-2 rounded-full bg-indigo-100 hover:bg-indigo-200 transition-all duration-300 shadow-md dark:bg-slate-700 dark:hover:bg-slate-600">
      <i id="themeIcon" data-lucide="moon" class="w-6 h-6 text-indigo-700 dark:text-amber-400"></i>
    </button>
  </nav>

  <!-- MAIN BODY -->
  <main class="flex-1 container mx-auto p-4 md:p-8 transition-all duration-300">

    <h2 class="text-3xl font-bold mb-6 text-center lg:text-left">Tkinter Code Generator from JSON - V0.1</h2>

    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
      
      <!-- LEFT PANEL: CONTROLS AND INFO -->
      <section class="bg-white p-6 rounded-xl shadow-2xl transition-all duration-300 dark:bg-slate-800">
        
        <h3 class="text-xl font-semibold mb-4 flex items-center gap-2 text-indigo-600 dark:text-indigo-400">
          <i data-lucide="file-json" class="w-5 h-5"></i> 1. Upload JSON Design File
        </h3>

        <!-- File Upload -->
        <input type="file" id="jsonFile" accept=".json"
               class="block w-full text-sm text-slate-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-indigo-50 file:text-indigo-700 hover:file:bg-indigo-100 dark:file:bg-indigo-900 dark:file:text-indigo-200 cursor-pointer transition mb-4">
        
        <!-- Status Message -->
        <div id="statusBox" class="p-3 rounded-lg border border-slate-200 dark:border-slate-700 text-sm mb-6 dark:text-slate-200">
          <i data-lucide="info" class="inline w-4 h-4 mr-1 text-sky-500"></i> 
          <span id="fileStatus">No file selected yet.</span>
        </div>

        <!-- Action Buttons -->
        <div class="flex flex-col sm:flex-row gap-3 mb-6">
          <button id="generateBtn" class="flex-1 flex items-center justify-center px-4 py-3 bg-indigo-600 text-white font-bold rounded-lg hover:bg-indigo-700 shadow-md transition-all duration-300 dark:bg-indigo-500 dark:hover:bg-indigo-600">
            <i data-lucide="wand-2" class="w-5 h-5 mr-2"></i> Generate & Validate Code
          </button>
          <button id="downloadBtn" class="flex-1 flex items-center justify-center px-4 py-3 bg-green-600 text-white font-bold rounded-lg hover:bg-green-700 shadow-md transition-all duration-300 dark:bg-green-500 dark:hover:bg-green-600">
            <i data-lucide="download" class="w-5 h-5 mr-2"></i> Download Python (.py)
          </button>
        </div>

        <!-- JSON Format Information -->
        <div class="info-box bg-sky-50 p-4 rounded-lg border-l-4 border-sky-500 dark:bg-slate-700 dark:border-sky-400 transition-all duration-300">
            <h4 class="font-bold text-sky-800 dark:text-sky-300 mb-2">Expected JSON Format:</h4>
            <pre class="text-xs bg-slate-200 dark:bg-slate-900 text-slate-800 dark:text-slate-200 p-2 rounded overflow-auto transition-all duration-300"><code>[
  { "type": "Window", "width": 800, "height": 600, "title": "Application Name" },
  { "type": "Label", "text": "Username:", "x": 50, "y": 50 },
  { "type": "Entry", "x": 160, "y": 50, "placeholder": "Enter your name" },
  { "type": "Button", "text": "Log In", "x": 160, "y": 100, "command": "login_handler" },
  { "type": "Checkbutton", "text": "Remember Me", "x": 50, "y": 150, "variable_name": "remember_var" },
  { "type": "Listbox", "x": 50, "y": 200, "width": 150, "height": 100, "options": ["Option 1", "Option 2"] }
]</code></pre>
            <p class="mt-2 text-xs text-sky-700 dark:text-sky-400">
                Supported Types: `Window`, `Label`, `Button`, `Entry`, `Checkbutton`, `Radiobutton`, `Listbox`.
                All components except `Window` require `x` and `y` (position).
            </p>
        </div>
      </section>

      <!-- RIGHT PANEL: CODE PREVIEW -->
      <aside class="bg-gray-800 text-white p-4 rounded-xl shadow-2xl flex flex-col dark:bg-slate-900 transition-all duration-300">
        <div class="flex items-center justify-between mb-3 border-b border-slate-700 pb-2">
          <h3 class="text-xl font-semibold flex items-center gap-2 text-amber-300">
            <i data-lucide="terminal" class="w-5 h-5"></i> 2. Generated Python Code
          </h3>
          <button id="copyBtn" class="px-3 py-1 bg-sky-600 text-white rounded-md hover:bg-sky-700 transition text-sm">
            <i data-lucide="clipboard-copy" class="inline w-4 h-4 mr-1"></i> Copy
          </button>
        </div>

        <div id="code-output-container" class="flex-1">
          <pre id="code-output" class="language-python text-sm">
<code class="language-python"># The code will appear here.
# Please upload a JSON file on the left and click 'Generate & Validate Code'.</code>
          </pre>
        </div>
        
        <p class="text-xs text-slate-400 mt-3 text-center">Your code is generated using Tkinter's `place` geometry manager.</p>
      </aside>

    </div>
  </main>

  <!-- FOOTER -->
  <footer class="container-fluid text-center p-3 bg-light mt-5 flex-grow:1 shadow-lg border-top border-dark">
    <div class="credits">
      &copy; <span> All Rights Reserved </span> <strong>Eda Mısırlıoğlu</strong>
    </div>
  </footer>

  <!-- JAVASCRIPT LOGIC -->
  <script>
    lucide.createIcons();

    const body = document.body;
    const navbar = document.getElementById('navbar');
    const navTitle = document.getElementById('navTitle');
    const jsonFile = document.getElementById('jsonFile');
    const fileStatus = document.getElementById('fileStatus');
    const statusBox = document.getElementById('statusBox');
    const generateBtn = document.getElementById('generateBtn');
    const copyBtn = document.getElementById('copyBtn');
    const downloadBtn = document.getElementById('downloadBtn');
    const codeOutput = document.getElementById('code-output');
    const themeToggle = document.getElementById('themeToggle');
    const themeIcon = document.getElementById('themeIcon');
    const codeOutputContainer = document.getElementById('code-output-container');
    
    let designData = null;
    let generatedCode = '';

    // --- JSON Schema (for AJV) ---
    const componentTypes = ['Window', 'Label', 'Button', 'Entry', 'Checkbutton', 'Radiobutton', 'Listbox'];
    const schema = {
        type: 'array',
        items: {
            type: 'object',
            properties: {
                type: { type: 'string', enum: componentTypes },
                x: { type: 'number', minimum: 0 },
                y: { type: 'number', minimum: 0 },
                width: { type: 'number', minimum: 1 },
                height: { type: 'number', minimum: 1 },
                text: { type: 'string' },
                placeholder: { type: 'string' },
                command: { type: 'string', pattern: '^[a-zA-Z_][a-zA-Z0-9_]*$' },
                variable_name: { type: 'string', pattern: '^[a-zA-Z_][a-zA-Z0-9_]*$' },
                value: { type: ['string', 'number'] },
                options: { type: 'array', items: { type: 'string' } }
            },
            required: ['type'],
            // x and y are mandatory for all components except 'Window'
            if: { properties: { type: { not: { const: 'Window' } } } },
            then: { required: ['x', 'y'] },
        }
    };
    const ajv = new Ajv({ allErrors: true });
    const validate = ajv.compile(schema);
    
    // --- Dark Mode Logic ---
    function setDarkMode(isDark) {
      if (isDark) {
        body.classList.add('dark', 'bg-slate-900', 'text-slate-100');
        body.classList.remove('bg-slate-100', 'text-slate-800');
        navbar.classList.replace('bg-white/80', 'bg-slate-900/80');
        themeIcon.setAttribute('data-lucide', 'sun');
        navTitle.classList.replace('text-slate-900', 'text-white'); 
      } else {
        body.classList.remove('dark', 'bg-slate-900', 'text-slate-100');
        body.classList.add('bg-slate-100', 'text-slate-800');
        navbar.classList.replace('bg-slate-900/80', 'bg-white/80');
        themeIcon.setAttribute('data-lucide', 'moon');
        navTitle.classList.replace('text-white', 'text-slate-900'); 
      }
      lucide.createIcons();
    }
    
    themeToggle.addEventListener('click', () => {
      const isDark = body.classList.contains('dark');
      setDarkMode(!isDark);
    });

    // Set default theme based on system preference
    setDarkMode(window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches);

    // --- File Upload ---
    jsonFile.addEventListener('change', e => {
      const file = e.target.files[0];
      if (!file) {
        fileStatus.textContent = 'No file selected yet.';
        statusBox.className = 'p-3 rounded-lg border border-slate-200 dark:border-slate-700 text-sm mb-6 dark:text-slate-200';
        designData = null;
        return;
      }

      const reader = new FileReader();
      reader.onload = evt => {
        try {
          const parsedData = JSON.parse(evt.target.result);
          if (!Array.isArray(parsedData)) {
            throw new Error("The main JSON structure must be an array.");
          }
          designData = parsedData;
          fileStatus.textContent = `✅ "${file.name}" uploaded. ${designData.length} component(s) found.`;
          statusBox.className = 'p-3 rounded-lg border border-green-300 bg-green-100 text-green-800 dark:border-green-700 dark:bg-green-900 dark:text-green-300 text-sm mb-6';
          
        } catch (err) {
          fileStatus.textContent = `❌ JSON Read Error: ${err.message}`;
          statusBox.className = 'p-3 rounded-lg border border-red-300 bg-red-100 text-red-800 dark:border-red-700 dark:bg-red-900 dark:text-red-300 text-sm mb-6';
          designData = null;
          codeOutput.innerHTML = `<code class="language-python"># Please upload a valid JSON format.</code>`;
        }
      };
      reader.readAsText(file);
    });

    // --- Code Generation and Validation ---
    generateBtn.addEventListener('click', () => {
      if (!designData || designData.length === 0) {
        fileStatus.textContent = 'Please upload a valid JSON file to generate code.';
        statusBox.className = 'p-3 rounded-lg border border-amber-300 bg-amber-100 text-amber-800 dark:border-amber-700 dark:bg-amber-900 dark:text-amber-300 text-sm mb-6';
        codeOutput.innerHTML = `<code class="language-python"># JSON Not Loaded.</code>`;
        return;
      }
      
      // Validation with AJV
      const valid = validate(designData);
      if (!valid) {
        const errorMsg = validate.errors.map(err => {
          // Clean up path: data[0].x -> Component 1: x
          const path = err.dataPath ? `Component ${parseInt(err.dataPath.match(/\d+/)?.[0] || '0') + 1}: ${err.dataPath.split('.').pop()}` : 'General';
          return `  - ${path}: ${err.message} (Value: ${JSON.stringify(err.data)})`;
        }).join('\n');

        fileStatus.textContent = `❌ JSON Schema Validation Error:\n${errorMsg}`;
        statusBox.className = 'p-3 rounded-lg border border-red-300 bg-red-100 text-red-800 dark:border-red-700 dark:bg-red-900 dark:text-red-300 whitespace-pre-wrap text-sm mb-6';
        codeOutput.innerHTML = `<code class="language-python"># Validation Error Occurred. Code generation failed.</code>`;
        generatedCode = '';
        return;
      }
      
      // Validation successful, generate code
      const result = generateTkinterCode(designData);
      generatedCode = result.code;
      
      codeOutput.textContent = generatedCode;
      // Enable syntax highlighting with Prism
      Prism.highlightElement(codeOutput);

      fileStatus.textContent = '✅ Code successfully generated and validated.';
      statusBox.className = 'p-3 rounded-lg border border-green-300 bg-green-100 text-green-800 dark:border-green-700 dark:bg-green-900 dark:text-green-300 text-sm mb-6';
    });

    // --- Tkinter Code Generation Function ---
    function generateTkinterCode(designData) {
        let elementCounter = 0;
        // Keep comments in English for the Python code itself
        let code = `import tkinter as tk\n\n`;
        
        // 1. Collect Event Handler Functions
        const commands = new Set();
        designData.forEach(elem => {
            if (elem.command) {
                commands.add(elem.command);
            }
        });

        // 1b. Function Definitions
        if (commands.size > 0) {
            code += `# Event Handlers - Modify these functions\n`;
            commands.forEach(cmd => {
                code += `def ${cmd}():\n`;
                code += `    print(f"'{cmd}' function called.") # Placeholder\n\n`;
            });
        }

        // 2. Main Window Settings
        let windowWidth = 800;
        let windowHeight = 600;
        let windowTitle = "Tkinter Application (JSON Generator)";

        const windowConfig = designData.find(elem => elem.type === 'Window');
        if (windowConfig) {
            if (windowConfig.width) windowWidth = windowConfig.width;
            if (windowConfig.height) windowHeight = windowConfig.height;
            if (windowConfig.title) windowTitle = windowConfig.title.replace(/"/g, '\\"');
        }

        code += `# Create main window\n`;
        code += `root = tk.Tk()\n`;
        code += `root.title("${windowTitle}")\n`;
        code += `root.geometry("${windowWidth}x${windowHeight}")\n\n`;
        
        // 3. Variable Definitions (for Checkbutton/Radiobutton)
        const variables = new Map();
        designData.forEach(elem => {
            if ((elem.type === 'Checkbutton' || elem.type === 'Radiobutton') && elem.variable_name) {
                const varType = elem.type === 'Checkbutton' ? 'IntVar' : 'StringVar';
                variables.set(elem.variable_name, varType);
            }
        });

        if (variables.size > 0) {
            code += `# Component Variables\n`;
            variables.forEach((type, name) => {
                code += `${name} = tk.${type}()\n`;
            });
            code += `\n`;
        }

        code += `# Create and place components (using place geometry manager)\n`;

        designData.forEach(elem => {
            if (elem.type === 'Window') return;

            elementCounter++;
            const name = elem.type.toLowerCase() + elementCounter;
            const text = elem.text ? elem.text.replace(/"/g, '\\"') : "";
            
            // --- Main Component Code Generation ---
            code += `# --- ${name} Component (${elem.type}) ---\n`;
            
            let commandOption = elem.command ? `, command=${elem.command}` : "";
            let variableOption = elem.variable_name ? `, variable=${elem.variable_name}` : "";
            let valueOption = elem.value ? `, value="${String(elem.value).replace(/"/g, '\\"')}"` : "";

            let listboxName = ""; 

            switch(elem.type) {
                case 'Button':
                    code += `${name} = tk.Button(root, text="${text}"${commandOption})\n`;
                    break;
                case 'Label':
                    code += `${name} = tk.Label(root, text="${text}")\n`;
                    break;
                case 'Entry':
                    code += `${name} = tk.Entry(root)\n`;
                    if (elem.placeholder) {
                        code += `${name}.insert(0, "${elem.placeholder.replace(/"/g, '\\"')}")\n`;
                    }
                    if (text) {
                        code += `${name}.insert(0, "${text}")\n`; 
                    }
                    break;
                case 'Checkbutton':
                    if (!elem.variable_name) {
                         code += `# WARNING: 'variable_name' missing for Checkbutton in JSON.\n`;
                    }
                    code += `${name} = tk.Checkbutton(root, text="${text}"${variableOption})\n`;
                    break;
                case 'Radiobutton':
                    if (!elem.variable_name) {
                        code += `# WARNING: 'variable_name' missing for Radiobutton in JSON.\n`;
                    }
                    if (!elem.value) {
                         valueOption = `, value="${text}"`;
                    }
                    code += `${name} = tk.Radiobutton(root, text="${text}"${variableOption}${valueOption})\n`;
                    break;
                case 'Listbox':
                    // Create Listbox
                    code += `${name} = tk.Listbox(root)\n`;
                    
                    // Create and connect Scrollbar
                    code += `${name}_scrollbar = tk.Scrollbar(root, command=${name}.yview)\n`;
                    code += `${name}.configure(yscrollcommand=${name}_scrollbar.set)\n`;

                    // Add options
                    if (elem.options && Array.isArray(elem.options)) {
                        elem.options.forEach(option => {
                            code += `${name}.insert(tk.END, "${String(option).replace(/"/g, '\\"')}")\n`;
                        });
                    }
                    listboxName = name; 
                    break;
                default:
                    code += `# WARNING: Unknown component type "${elem.type}" skipped.\n\n`;
                    return;
            }

            // --- Apply Place Method ---
            let placeOptions = `x=${elem.x}, y=${elem.y}`;
            if (elem.width != null) {
                placeOptions += `, width=${elem.width}`;
            }
            if (elem.height != null) {
                placeOptions += `, height=${elem.height}`;
            }

            // Listbox special case: Place Scrollbar next to it
            if (elem.type === 'Listbox') {
                code += `${listboxName}.place(${placeOptions})\n`; 
                
                // Place Scrollbar
                const defaultListboxWidth = 200; 
                const defaultListboxHeight = 100;
                let scrollbar_x = elem.x + (elem.width || defaultListboxWidth);
                let scrollbar_h = elem.height || defaultListboxHeight;
                
                code += `${listboxName}_scrollbar.place(x=${scrollbar_x}, y=${elem.y}, width=16, height=${scrollbar_h})\n\n`;

            } else {
                // Place all other components
                code += `${name}.place(${placeOptions})\n\n`;
            }
            
        });

        code += `# Start main loop\n`;
        code += `root.mainloop()\n`;

        return { code: code };
    }


    // --- Copy Operation ---
    copyBtn.addEventListener('click', () => {
      if (!generatedCode) {
        fileStatus.textContent = 'Please generate code first to copy!';
        statusBox.className = 'p-3 rounded-lg border border-amber-300 bg-amber-100 text-amber-800 dark:border-amber-700 dark:bg-amber-900 dark:text-amber-300 text-sm mb-6';
        return;
      }
      navigator.clipboard.writeText(generatedCode)
        .then(() => {
          copyBtn.innerHTML = '<i data-lucide="check" class="inline w-4 h-4 mr-1"></i> Copied!';
          lucide.createIcons();
          setTimeout(() => { copyBtn.innerHTML = '<i data-lucide="clipboard-copy" class="inline w-4 h-4 mr-1"></i> Copy'; lucide.createIcons(); }, 2000);
        })
        .catch(err => {
          const textArea = document.createElement("textarea");
          textArea.value = generatedCode;
          document.body.appendChild(textArea);
          textArea.select();
          try {
            document.execCommand('copy');
            copyBtn.innerHTML = '<i data-lucide="check" class="inline w-4 h-4 mr-1"></i> Copied!';
            lucide.createIcons();
            setTimeout(() => { copyBtn.innerHTML = '<i data-lucide="clipboard-copy" class="inline w-4 h-4 mr-1"></i> Copy'; lucide.createIcons(); }, 2000);
          } catch (error) {
            console.error('Copy failed:', error);
            fileStatus.textContent = 'Copy failed. Check the console.';
          }
          document.body.removeChild(textArea);
        });
    });

    // --- Download Operation ---
    downloadBtn.addEventListener('click', () => {
      if (!generatedCode) {
        fileStatus.textContent = 'Please generate code first to download the file!';
        statusBox.className = 'p-3 rounded-lg border border-amber-300 bg-amber-100 text-amber-800 dark:border-amber-700 dark:bg-amber-900 dark:text-amber-300 text-sm mb-6';
        return;
      }
      const blob = new Blob([generatedCode], { type: 'text/x-python' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url; a.download = 'generated_tkinter_app.py';
      a.click(); URL.revokeObjectURL(url);
      
      downloadBtn.innerHTML = '<i data-lucide="check" class="inline w-5 h-5 mr-2"></i> Downloaded!';
      lucide.createIcons();
      setTimeout(() => { downloadBtn.innerHTML = '<i data-lucide="download" class="inline w-5 h-5 mr-2"></i> Download Python (.py)'; lucide.createIcons(); }, 2000);
    });
  </script>
</body>
</html>